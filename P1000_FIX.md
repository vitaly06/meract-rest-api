# Решение проблемы P1000: Authentication failed

## Проблема

PostgreSQL периодически отказывает в аутентификации пользователю `postgres` из-за конфликта между:

1. `docker-entrypoint-initdb.d/dump.sql` (загружается автоматически при создании контейнера)
2. `prisma db push` (пересоздаёт структуру БД, что может повредить системные таблицы)

## Решение

### 1. Отключён автоматический дамп

Дамп больше НЕ загружается автоматически при старте контейнера (закомментирован в docker-compose.yml).

### 2. Обновлён PostgreSQL

- Изменён с `postgres:13-alpine` на `postgres:15-alpine`
- Добавлен `scram-sha-256` вместо устаревшего `md5` (более безопасная аутентификация)

### 3. Улучшен PrismaService

- Добавлено логирование подключения
- Автоматическое переподключение при ошибках (до 5 попыток)
- Проверка текущего пользователя и версии БД

### 4. Возвращён `prisma db push`

Теперь структура БД создаётся через Prisma Schema, а не через дамп.

## Инструкции по развёртыванию

### Шаг 1: Пересоздать контейнеры

```powershell
# Остановить и удалить контейнеры с данными
docker compose down -v

# Убедиться, что volume удалён
docker volume ls
docker volume rm meract-rest-api_postgres_data -f

# Запустить заново
docker compose up -d
```

### Шаг 2: Дождаться полного старта

```powershell
# Смотреть логи приложения
docker compose logs -f app

# Вы должны увидеть:
# ✅ Database connected successfully
# Connected as: [{"current_user":"postgres","current_database":"Meract",...}]
```

### Шаг 3 (опционально): Загрузить дамп вручную

Если нужны данные из дампа:

```powershell
# Убедитесь, что в docker-compose.yml есть строка с dump.sql (раскомментируйте)
# volumes:
#   - ./dumps/dump.sql:/docker-entrypoint-initdb.d/dump.sql

# Перезапустить только БД
docker compose restart db

# Подождать 10 секунд, затем загрузить дамп
docker compose exec db psql -U postgres -d Meract -f /docker-entrypoint-initdb.d/dump.sql
```

### Альтернативный способ: без дампа, с seed-данными

Создайте `prisma/seed.ts` для загрузки тестовых данных:

```typescript
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  // Создание ролей
  await prisma.role.createMany({
    data: [
      { id: 1, name: 'user' },
      { id: 2, name: 'admin' },
      { id: 3, name: 'main admin' },
    ],
    skipDuplicates: true,
  });

  // Создание тестовых пользователей и т.д.
}

main()
  .catch((e) => console.error(e))
  .finally(() => prisma.$disconnect());
```

Затем в `package.json`:

```json
"prisma": {
  "seed": "ts-node prisma/seed.ts"
}
```

И запустить: `npx prisma db seed`

## Диагностика

### Проверить статус БД

```powershell
docker compose exec db psql -U postgres -d Meract -c "SELECT usename, valuntil FROM pg_user WHERE usename='postgres';"
```

### Проверить логи PostgreSQL

```powershell
docker compose logs db | Select-String -Pattern "FATAL|ERROR|authentication"
```

### Проверить подключение приложения

```powershell
docker compose logs app | Select-String -Pattern "Database connected|P1000|authentication"
```

## Если проблема осталась

1. **Полная очистка Docker:**

```powershell
docker compose down -v
docker system prune -a --volumes -f
docker compose up -d --build
```

2. **Временный патч (крайняя мера):**
   Добавить в docker-compose.yml для db:

```yaml
entrypoint: >
  sh -c "
  (
    while true; do
      sleep 60;
      PGPASSWORD=postgres psql -U postgres -c \"ALTER USER postgres WITH PASSWORD 'postgres';\" || true;
    done
  ) &
  exec docker-entrypoint.sh postgres
  "
```

3. **Использовать внешнюю БД:**
   Вместо контейнера PostgreSQL подключиться к отдельному инстансу (не в Docker).
